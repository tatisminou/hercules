<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Monitor - Test</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
  <div x-data="app()" x-init="initAuth()">
    <!-- Sign-in screen (shown when not authenticated) -->
    <template x-if="!user && !authLoading">
      <section class="hero is-fullheight">
        <div class="hero-body">
          <div class="container has-text-centered">
            <p class="title is-4 mb-5">Sign in required</p>
            <button class="button is-primary is-medium" @click="signIn">
              <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg></span>
              <span>Sign in with Google</span>
            </button>
          </div>
        </div>
      </section>
    </template>

    <!-- Loading spinner (shown while checking auth) -->
    <template x-if="authLoading">
      <section class="hero is-fullheight">
        <div class="hero-body">
          <div class="container has-text-centered">
            <button class="button is-loading is-large is-white"></button>
          </div>
        </div>
      </section>
    </template>

    <!-- Main App (shown when authenticated) -->
    <template x-if="user">
      <section class="section">
        <div class="container">
          <!-- App Header -->
          <nav class="level mb-5">
            <div class="level-left">
              <div class="level-item">
                <h1 class="title">Portfolio Monitor</h1>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <div class="tags has-addons">
                  <span class="tag is-medium is-info" x-text="user?.displayName || user?.email"></span>
                  <a class="tag is-medium is-delete" @click="signOut"></a>
                </div>
              </div>
            </div>
          </nav>

          <p class="subtitle">Firebase + Finnhub Test Page</p>

          <!-- Test 1: Basic Function -->
          <div class="box">
            <h2 class="title is-5">Test 1: Firebase Function</h2>
            <button class="button is-primary" @click="testHello" :class="{'is-loading': loadingHello}">
              Test Hello Endpoint
            </button>
            <pre class="mt-3" x-show="helloResult" x-text="helloResult"></pre>
          </div>

          <!-- Test 2: Finnhub Quote -->
          <div class="box">
            <h2 class="title is-5">Test 2: Finnhub Stock Quote</h2>
            <div class="field has-addons">
              <div class="control">
                <input class="input" type="text" x-model="symbol" placeholder="AAPL">
              </div>
              <div class="control">
                <button class="button is-info" @click="getQuote" :class="{'is-loading': loadingQuote}">
                  Get Quote
                </button>
              </div>
            </div>

            <div class="mt-3" x-show="quoteError">
              <div class="notification is-danger" x-text="quoteError"></div>
            </div>

            <div class="mt-3" x-show="quote">
              <table class="table is-fullwidth">
                <tr><th>Symbol</th><td x-text="quote?.symbol"></td></tr>
                <tr><th>Current Price</th><td x-text="'$' + quote?.current"></td></tr>
                <tr><th>Change</th><td :class="quote?.change >= 0 ? 'has-text-success' : 'has-text-danger'" x-text="(quote?.change >= 0 ? '+' : '') + quote?.change + ' (' + quote?.changePercent + '%)'"></td></tr>
                <tr><th>High</th><td x-text="'$' + quote?.high"></td></tr>
                <tr><th>Low</th><td x-text="'$' + quote?.low"></td></tr>
                <tr><th>Open</th><td x-text="'$' + quote?.open"></td></tr>
                <tr><th>Previous Close</th><td x-text="'$' + quote?.previousClose"></td></tr>
              </table>
            </div>
          </div>

          <!-- Test 3: Symbol Search -->
          <div class="box">
            <h2 class="title is-5">Test 3: Symbol Search</h2>
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" type="text" x-model="searchQuery" placeholder="Search stocks (e.g., Apple, TSLA, Lloyds)">
              </div>
              <div class="control">
                <button class="button is-success" @click="searchSymbols" :class="{'is-loading': loadingSearch}">
                  Search
                </button>
              </div>
            </div>

            <div class="mt-3" x-show="searchError">
              <div class="notification is-danger" x-text="searchError"></div>
            </div>

            <div class="mt-3" x-show="searchResults.length > 0">
              <p class="mb-2"><strong x-text="searchResults.length + ' results found'"></strong></p>
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr><th>Symbol</th><th>Name</th><th>Type</th><th>Exchange</th></tr>
                </thead>
                <tbody>
                  <template x-for="(item, index) in searchResults" :key="index">
                    <tr @click="selectSymbol(item.symbol)" style="cursor: pointer;" :class="{'is-selected': selectedSymbol === item.symbol}">
                      <td><strong x-text="item.symbol"></strong></td>
                      <td x-text="item.description"></td>
                      <td><span class="tag" x-text="item.type"></span></td>
                      <td x-text="item.exchange"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Selected stock quote -->
            <div class="mt-4" x-show="selectedQuote">
              <div class="notification is-info is-light">
                <div class="level mb-2">
                  <div class="level-left">
                    <p class="is-size-5">
                      <strong x-text="selectedQuote?.name || selectedSymbol"></strong>
                      <span class="tag is-light ml-2" x-text="selectedQuote?.currency === 'GBp' ? 'GBP' : (selectedQuote?.currency || 'USD')"></span>
                      <span class="tag is-light ml-1" x-text="selectedQuote?.source"></span>
                      <span class="tag is-success ml-1" x-show="selectedStockId">Registered</span>
                    </p>
                  </div>
                  <div class="level-right">
                    <button class="button is-primary is-small"
                            @click="addStock(selectedSymbol)"
                            :class="{'is-loading': addingStock}"
                            :disabled="selectedStockId"
                            x-show="!selectedStockId">
                      Add Stock
                    </button>
                  </div>
                </div>
                <div class="columns">
                  <div class="column">
                    <p><strong>Price:</strong> <span x-text="formatCurrency(selectedQuote?.current, selectedQuote?.currency)"></span></p>
                    <p><strong>Change:</strong> <span :class="selectedQuote?.change >= 0 ? 'has-text-success' : 'has-text-danger'" x-text="formatChange(selectedQuote?.change, selectedQuote?.changePercent, selectedQuote?.currency)"></span></p>
                  </div>
                  <div class="column">
                    <p><strong>High:</strong> <span x-text="formatCurrency(selectedQuote?.high, selectedQuote?.currency)"></span></p>
                    <p><strong>Low:</strong> <span x-text="formatCurrency(selectedQuote?.low, selectedQuote?.currency)"></span></p>
                  </div>
                  <div class="column">
                    <p><strong>Open:</strong> <span x-text="formatCurrency(selectedQuote?.open, selectedQuote?.currency)"></span></p>
                    <p><strong>Prev Close:</strong> <span x-text="formatCurrency(selectedQuote?.previousClose, selectedQuote?.currency)"></span></p>
                  </div>
                </div>
                <p class="help" x-show="selectedStockId">Stock ID: <span x-text="selectedStockId"></span></p>
              </div>
            </div>

            <div class="mt-3" x-show="selectedLoading">
              <p class="has-text-grey"><span class="loader is-loading"></span> Loading quote...</p>
            </div>

            <div class="mt-3" x-show="selectedError">
              <div class="notification is-warning" x-text="selectedError"></div>
            </div>
          </div>

          <!-- Config info -->
          <div class="box">
            <h2 class="title is-5">Configuration</h2>
            <p><strong>Functions URL:</strong> <span x-text="functionsBase"></span></p>
            <p><strong>User ID:</strong> <span x-text="user?.uid"></span></p>
            <p class="help">Authenticated requests include ID token</p>
          </div>
        </div>
      </section>
    </template>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "xxx",
      authDomain: "tuplebox-hercules.firebaseapp.com",
      projectId: "tuplebox-hercules",
      storageBucket: "tuplebox-hercules.firebasestorage.app",
      messagingSenderId: "144957092094",
      appId: "1:144957092094:web:0986ef094392481282b5af"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    function app() {
      return {
        // UPDATE THIS after deploying functions!
        functionsBase: 'https://europe-west2-tuplebox-hercules.cloudfunctions.net',

        // Auth state
        user: null,
        idToken: null,
        authLoading: true,

        symbol: 'AAPL',
        loadingHello: false,
        loadingQuote: false,
        helloResult: '',
        quote: null,
        quoteError: '',

        searchQuery: '',
        loadingSearch: false,
        searchResults: [],
        searchError: '',

        selectedSymbol: '',
        selectedQuote: null,
        selectedLoading: false,
        selectedError: '',
        selectedStockId: null,
        addingStock: false,

        // Auth methods
        initAuth() {
          firebase.auth().onAuthStateChanged(async (user) => {
            this.user = user;
            if (user) {
              this.idToken = await user.getIdToken();
            } else {
              this.idToken = null;
            }
            this.authLoading = false;
          });
        },

        async signIn() {
          this.authLoading = true;
          try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await firebase.auth().signInWithPopup(provider);
          } catch (e) {
            console.error('Sign in error:', e);
            this.authLoading = false;
          }
        },

        async signOut() {
          await firebase.auth().signOut();
        },

        // Helper to make authenticated requests
        async authFetch(url) {
          if (this.idToken) {
            // Refresh token if needed
            this.idToken = await firebase.auth().currentUser.getIdToken();
          }
          return fetch(url, {
            headers: this.idToken ? { 'Authorization': `Bearer ${this.idToken}` } : {}
          });
        },

        async testHello() {
          this.loadingHello = true;
          this.helloResult = '';
          try {
            const res = await this.authFetch(`${this.functionsBase}/hello`);
            const data = await res.json();
            this.helloResult = JSON.stringify(data, null, 2);
          } catch (e) {
            this.helloResult = 'Error: ' + e.message;
          }
          this.loadingHello = false;
        },

        async getQuote() {
          this.loadingQuote = true;
          this.quote = null;
          this.quoteError = '';
          try {
            const res = await this.authFetch(`${this.functionsBase}/getQuote?symbol=${this.symbol}`);
            const data = await res.json();
            if (data.error) {
              this.quoteError = data.error;
            } else {
              this.quote = data;
            }
          } catch (e) {
            this.quoteError = 'Error: ' + e.message;
          }
          this.loadingQuote = false;
        },

        async searchSymbols() {
          this.loadingSearch = true;
          this.searchResults = [];
          this.searchError = '';
          try {
            const res = await this.authFetch(`${this.functionsBase}/searchSymbol?q=${encodeURIComponent(this.searchQuery)}`);
            const data = await res.json();
            if (data.error) {
              this.searchError = data.error;
            } else {
              this.searchResults = data.results;
            }
          } catch (e) {
            this.searchError = 'Error: ' + e.message;
          }
          this.loadingSearch = false;
        },

        async selectSymbol(symbol) {
          this.selectedSymbol = symbol;
          this.selectedQuote = null;
          this.selectedError = '';
          this.selectedStockId = null;
          this.selectedLoading = true;
          try {
            const res = await this.authFetch(`${this.functionsBase}/getQuote?symbol=${symbol}`);
            const data = await res.json();
            if (data.error) {
              this.selectedError = data.error;
            } else {
              this.selectedQuote = data;
            }
          } catch (e) {
            this.selectedError = 'Error: ' + e.message;
          }
          this.selectedLoading = false;
        },

        async addStock(symbol) {
          this.addingStock = true;
          try {
            const res = await this.authFetch(`${this.functionsBase}/registerStock?symbol=${symbol}`);
            const data = await res.json();
            if (data.error) {
              this.selectedError = data.error;
            } else {
              this.selectedStockId = data.stockId;
              // Update quote with cached price from registration
              if (data.price) {
                this.selectedQuote = {
                  ...this.selectedQuote,
                  ...data.price,
                  name: data.stock?.name || this.selectedQuote?.name
                };
              }
            }
          } catch (e) {
            this.selectedError = 'Error: ' + e.message;
          }
          this.addingStock = false;
        },

        formatCurrency(value, currency) {
          if (value == null) return '-';
          const num = parseFloat(value).toFixed(2);
          // Pence: show as 98.24p (suffix)
          if (currency === 'GBp') {
            return num + 'p';
          }
          const symbols = {
            'USD': '$', 'GBP': '£', 'EUR': '€', 'JPY': '¥',
            'CHF': 'CHF ', 'CAD': 'C$', 'AUD': 'A$', 'HKD': 'HK$'
          };
          const symbol = symbols[currency] || (currency ? currency + ' ' : '$');
          return symbol + num;
        },

        formatChange(change, percent, currency) {
          if (change == null) return '-';
          const num = parseFloat(change).toFixed(2);
          const sign = parseFloat(change) >= 0 ? '+' : '';
          // Pence: show as +0.47p
          if (currency === 'GBp') {
            return `${sign}${num}p (${parseFloat(percent).toFixed(2)}%)`;
          }
          return `${sign}${num} (${parseFloat(percent).toFixed(2)}%)`;
        }
      }
    }
  </script>
</body>
</html>
